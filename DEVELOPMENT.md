# U-FRET PRO 開發思路與技術架構實錄 (v19.5.1)

這份文件詳盡記錄了 **U-FRET PRO Crawler** 從一個單純的爬蟲腳本，演進為具備自動化排程、雲端持久化與精準分頁邏輯的成熟 Web 服務的過程。

---

## 🎨 第一階段：美學與交互的重生 (UX Reflection)
**目標**：將生硬的資料轉化為極致的視覺體驗。
- **暗黑美學**：採用 Apple 風格的深灰色調（`#121212`），搭配玻璃擬態（Glassmorphism）與微發光（Glow）效果，強化「專業感」。
- **即時反饋**：
    - 使用心形（♥）與星形（★）圖標，並以紅色/黃色高亮區分「跟隨歌手」與「收藏歌曲」。
    - 點擊操作即時觸發 API，並透過 `location.reload()` 確保 UI 狀態與資料庫同步。

---

## 🏗️ 第二階段：雲端持久化與穩定性 (Cloud Architecture)
**挑戰**：雲端平台（如 Zeabur）重啟即重設，資料無法留存，且 Proxy 會有 502/504 逾時限制。
- **資料分選 (Data Segregation)**：
    - 建立專屬 `data/` 資料夾，整合所有 `.json` 分類池與 `.txt` 設定檔。
    - **Zeabur Volume**：配置伺服器掛載 `/app/data/`，確保收藏與設定不會隨伺服器重啟而消失。
- **502 逾時解法**：
    - **非同步元數據檢查**：將耗時的「新收藏網址解析」移至後台執行緒 (`threading`)。
    - **秒開首頁**：確保首頁響應不被外部請求阻塞，徹底消除雲端閘道的 502 報錯。

---

## 🧠 第三階段：精準過濾與分頁邏輯 (Logic Refinement)
**設計思路**：區分「監控」與「倉庫」。
- **Following (監控區)**：定位為「新曲監控」。只從當天抓到的「新曲/影片」中篩選出您關注的歌手，保持清爽與時效性。
- **Piano (鋼琴專區)**：整合多重來源。除了新曲外，專門爬取 [piano.php](https://www.ufret.jp/piano.php)；且關鍵在於**「全局掃描」**——只要在資料庫中偵測到「ピアノ」標籤的曲目，都會被完整收納，確保歷史抓取的鋼琴譜（如您提到的 8 首）永不遺失。
- **Saved (倉庫區)**：使用者意向的終點。不論新舊，只要是手動 Import 或點擊星星收藏的，都會永久保存於此。

---

## ⏰ 第四階段：自動化營運 (Automation)
**核心功能**：讓使用者「不用手動點 Sync」也能看到最新資料。
- **精準排程**：
    - 每天中午 `12:00` 自動觸發全局同步。
    - **漏抓補救機制**：啟動時檢查「今天是否已同步」，若錯過排程（如伺服器剛啟動），會立即補課抓取，確保資料不中斷。
- **手動 Import**：將手動輸入 URL 改為同步處理（轉圈圈等待），確保使用者按下 Import 後「立即」能在 Saved 看到新歌，提升操作直覺。

---

## 🛠️ 技術組件總覽
| 組件 | 說明 | 
| :--- | :--- |
| **並行控制** | 使用 `threading.RLock` 防止多用戶或排程同時寫入資料庫造成損壞。 |
| **數據清洗** | 結合 Regex 與 BeautifulSoup，精確剔除「NEW」、「初心者」等裝飾文字。 |
| **網路層** | `httpx` 非同步請求 + `0.0.0.0` 綁定，適應所有 Docker 與雲端環境。 |
| **版本控制** | `main` 分支負責雲端推播；`local-version` 分支保持本地路徑簡潔。 |

---

## 🔮 未來路線圖 (Roadmap)
1. **歌譜內容預覽**：直接在 Dashboard 預覽曲目難度與調性。
2. **多重排序方案**：提供「按發現時間」、「按歌手名字」切換排序。
3. **PUSH 通知**：整合 LINE 或是 Telegram Bot，當追蹤歌手出新歌時第一時間推播。

---
*U-FRET PRO - From Script to Service.*
